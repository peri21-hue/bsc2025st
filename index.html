<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="./WF.png">
  <link rel="shortcut icon" href="./WF.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BSC2025Stats</title>
  <style>
    :root{
      --bg-0:#0a0e16; --bg-1:#0e1424; --bg-2:#111a31;
      --line:rgba(255,255,255,.08);
      --text:#e9efff; --muted:#9bb0d6;
      /* ‚ö†Ô∏è degradado a naranja */
      --acc-1:#ff6a00; --acc-2:#ffb84a;
      --blue:#5b7cff; --green:#34d399; --red:#f43f5e;
      --maxw:1380px; /* ensanchado */
      --logo-bg:#0b101d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(900px 500px at -10% -10%, #1b2a5e 0%, rgba(27,42,94,0) 60%),
        radial-gradient(900px 700px at 110% 0%, #0f2048 0%, rgba(15,32,72,0) 60%),
        var(--bg-0);
    }
    a{color:inherit;text-decoration:none}
    
    .topbar{position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);
      background:linear-gradient(180deg,rgba(10,14,22,.95),rgba(10,14,22,.6));
      border-bottom:1px solid var(--line);}
    .topnav{max-width:var(--maxw);margin:auto;padding:10px 18px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .logo{width:34px;height:34px;border-radius:10px;overflow:hidden;background:#0a0e16}
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .tabs{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}

    .subhead{max-width:var(--maxw);margin:14px auto 0;padding:0 18px 14px}
    .crumbs{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.12em}
    .eventbar{margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:14px}
    .eventname{font-weight:900;font-size:28px}
    /* üî∂ ‚ÄúBrawl Stars‚Äù con naranja */
    .eventname span{background:linear-gradient(90deg,var(--acc-2),var(--acc-1));-webkit-background-clip:text;background-clip:text;color:transparent}
    .pillnav{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted);font-weight:600;font-size:12px}
    .pill.active{background:linear-gradient(180deg,rgba(124,135,255,.18),rgba(51,211,255,.12));color:var(--text);border-color:rgba(124,135,255,.35)}

    main{max-width:var(--maxw);margin:0 auto;padding:0 18px 80px}

    .view{display:none;animation:fade .18s ease-out}
    .view.active{display:block}
    @keyframes fade{from{opacity:.6;transform:translateY(3px)}to{opacity:1;transform:none}}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:14px 0}
    @media (max-width:1000px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:14px 16px;
      background:linear-gradient(180deg,var(--bg-1),var(--bg-2));border:1px solid var(--line);border-radius:14px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-weight:900;font-size:20px}
    .span-2{grid-column:span 2}

    /* AD (Discord) */
    .ad{height:120px;border:1px solid var(--line);border-radius:14px;overflow:hidden;margin:12px 0}
    .ad a{display:block;height:100%}
    .ad img{width:100%;height:100%;object-fit:cover;display:block}

    .grid{display:grid;grid-template-columns:1.3fr 1.2fr .9fr;gap:12px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--bg-1),var(--bg-2));border:1px solid var(--line);border-radius:18px}
    .pad{padding:16px}
    .cardhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .ch-left{display:flex;align-items:center;gap:10px}
    .cw{width:28px;height:28px;border-radius:8px;background:rgba(255,255,255,.06);display:grid;place-items:center}
    .cw img{width:22px;height:22px;display:block}

    .ctitle{font-weight:900}
    .csub{color:var(--muted);font-size:12px;margin-top:2px}

    /* logos unificados */
    .champ{display:flex;align-items:center;gap:8px}
    .cimg{
      width:34px;height:34px;border-radius:10px;overflow:hidden;
      border:1px solid rgba(255,255,255,.18);background:var(--logo-bg);
      display:grid;place-items:center;padding:3px;
    }
    .cimg img{width:100%;height:100%;object-fit:contain;display:block}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:12px 10px;border-bottom:1px dashed var(--line);text-align:left}
    th{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    .wr-table th:nth-child(n+2), .wr-table td:nth-child(n+2){ text-align:center }

    .chart{padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
    canvas{width:100%;height:360px;display:block}

    .livegrid{display:grid;grid-template-columns:1fr;gap:10px}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03)}
    .side{display:flex;align-items:center;gap:8px;min-width:0}
    .right{justify-content:flex-end}
    .tlogo{width:34px;height:34px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.15);background:var(--logo-bg);display:grid;place-items:center;padding:3px}
    .tlogo img{width:100%;height:100%;object-fit:contain;display:block}
    .tname{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* ===== H2H ===== */
    .matrix{overflow:auto;border:1px solid var(--line);border-radius:14px}
    /* ‚ùå sin min-width gigante => cabe sin barra horizontal */
    .matrix table{width:100%;table-layout:fixed;min-width:0}
    .matrix th,.matrix td{padding:10px 8px;border-bottom:1px dashed var(--line);border-right:1px dashed var(--line);font-size:12px}
    .matrix th:last-child,.matrix td:last-child{border-right:none}
    .matrix thead th{vertical-align:bottom}
    .h2h-colhead{display:flex;flex-direction:column;align-items:center;gap:6px}
    .h2h-colhead .cimg{width:34px;height:34px}
    .h2h-leftcell{min-width:230px} /* un pel√≠n m√°s ancha para logos iguales */
    .cell-empty{opacity:.35}
    .cell-diag{background:rgba(255,255,255,.04)}

    /* ===== Teams ===== */
    .teams-wrapper{display:grid;gap:18px;margin-top:14px}
    .group-block{border:1.35px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0f1628,#0b101d);padding:12px}
    .group-title{display:flex;align-items:center;gap:10px;font-weight:900;margin:4px 4px 12px}
    .group-grid{display:grid;grid-template-columns:1fr 1fr 1fr;grid-auto-rows:auto;gap:12px}
    @media (max-width:1100px){.group-grid{grid-template-columns:1fr}}

    .team-card{border:1.5px solid var(--line);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#0f1628,#0b101d)}
    .team-head{display:flex;align-items:center;gap:12px;padding:14px 14px 10px}
    .team-logo{width:46px;height:46px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.18);flex-shrink:0;background:var(--logo-bg);display:grid;place-items:center;padding:3px}
    .team-logo img{width:100%;height:100%;object-fit:contain}
    .team-title{font-size:18px;font-weight:900;line-height:1.1}
    .team-meta{font-size:12px;color:var(--muted)}
    .team-pill{margin-left:auto;font-size:11px;color:#0a1a12;padding:4px 10px;border-radius:999px;border:1px solid rgba(52,211,153,.45);background:linear-gradient(135deg,rgba(52,211,153,.35),rgba(52,211,153,.15));font-weight:800;letter-spacing:.06em}
    .roster-wrap{display:grid;grid-template-columns:1fr;gap:8px;padding:0 12px 12px}
    .roster-section{border-top:1px dashed var(--line);padding-top:10px}
    .section-title{font-size:12px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;margin:4px 2px 6px}
    .member{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.03)}
    .member.staff{background:linear-gradient(180deg,rgba(124,135,255,.07),rgba(51,211,255,.05))}
    .flag-img{width:22px;height:22px;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.2);background:var(--logo-bg);flex-shrink:0;display:grid;place-items:center}
    .flag-img img{width:100%;height:100%;object-fit:cover}
    .member-name{font-weight:800}
    .member-role{margin-left:auto;display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .role-chip{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);font-weight:700;letter-spacing:.04em}
    .role-chip.coach{border-color:rgba(251,191,36,.45);background:rgba(251,191,36,.12);color:#f8d481}
    .role-chip.analyst{border-color:rgba(91,124,255,.45);background:rgba(91,124,255,.12);color:#a9b9ff}
    .role-chip.manager{border-color:rgba(52,211,153,.45);background:rgba(52,211,153,.12);color:#8be3c3}

    .matches-board{border:1.35px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0f1628,#0b101d);padding:10px 10px}
    .mb-title{font-weight:900;margin:4px 6px 10px}
    .mb-row{display:grid;grid-template-columns:1fr 24px 1fr;align-items:center;gap:8px;border-top:1px dashed var(--line);padding:10px 6px}
    .mb-row:first-of-type{border-top:none}
    .mb-round{grid-column:1 / -1;color:var(--muted);font-size:12px;margin-top:6px;margin-bottom:-2px}
    .mb-team{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--line);border-radius:8px;background:rgba(255,255,255,.03)}
    .mb-center{display:grid;place-items:center;height:40px;position:relative}
    .mb-center::before{content:"";position:absolute;left:50%;top:-24px;bottom:-24px;width:2px;background:linear-gradient(#ffffff22,#ffffff22) no-repeat center/2px 100%}
    .mb-badge{font-weight:800;letter-spacing:.06em}
    .mb-muted{color:var(--muted);font-size:12px;margin-left:6px}

    /* ===== Casters ===== */
    .casters-layout{display:grid;grid-template-columns:1fr 1fr .9fr;grid-auto-rows:minmax(220px,auto);gap:12px;margin-top:14px}
    @media (max-width:1100px){.casters-layout{grid-template-columns:1fr}.scrims-bar{grid-row:auto}}
    .creator-card{position:relative;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#0f1628,#0b101d);display:flex;flex-direction:column;min-height:220px}
    .creator-card::before{content:"";position:absolute;inset:0 0 40% 0;background:radial-gradient(220px 120px at 50% -20%, rgba(19,255,161,.28), rgba(19,255,161,0)),radial-gradient(260px 160px at 90% -30%, rgba(69,255,188,.22), rgba(69,255,188,0));pointer-events:none}
    .creator-top{display:flex;align-items:flex-end;gap:14px;padding:18px 16px 8px;z-index:1}
    .creator-avatar{width:92px;height:92px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.18);background:var(--logo-bg);flex-shrink:0;display:grid;place-items:center}
    .creator-avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .creator-name{font-weight:900;font-size:22px;line-height:1.1}
    .creator-real{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px;margin-top:4px}
    .creator-flag{width:18px;height:18px;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.2);background:var(--logo-bg)}
    .creator-flag img{width:100%;height:100%;object-fit:cover;display:block}
    .creator-footer{margin-top:auto;border-top:1px dashed var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn-icon{display:inline-flex;align-items:center;justify-content:center;width:38px;height:34px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);transition:.2s}
    .btn-icon:hover{background:rgba(255,255,255,.08)}
    .btn-icon img{width:18px;height:18px;display:block}
    .live-chip{font-size:10px;font-weight:900;padding:2px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.2);
      background:linear-gradient(135deg,rgba(255,122,122,.4),rgba(255,207,122,.3));color:#071118}

    .scrims-bar{border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0e1424,#111a31);padding:14px;grid-column:3;grid-row:1 / span 2;display:flex;flex-direction:column;gap:10px}
    .scrims-bar .title{font-weight:900}
    .live-item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.03);margin-bottom:8px}
    .live-item .avatar{width:38px;height:38px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.18);background:var(--logo-bg)}
    .live-item .avatar img{width:100%;height:100%;object-fit:cover}
    .live-item .title{font-weight:700;font-size:13px;line-height:1.2}
    .live-item .author{color:var(--muted);font-size:12px;margin-top:2px}
    .platforms{display:flex;gap:8px;flex-direction:column;align-items:flex-end}
    .platforms a{display:inline-flex;align-items:center;gap:8px;justify-content:center;height:32px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,.04);padding:0 10px;font-weight:800}
    .platforms a img{width:18px;height:18px}

    /* ===== Videos ===== */
    .videos-block{margin-top:14px;border-top:1px dashed var(--line);padding-top:12px}
    .videos-title{font-weight:900;margin:4px 6px 10px}
    .videos-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:1100px){.videos-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.videos-grid{grid-template-columns:1fr}}
    .video-card{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:linear-gradient(180deg,#0f1628,#0b101d);display:flex;flex-direction:column}
    .video-thumb{position:relative;aspect-ratio:16/9;background:var(--logo-bg)}
    .video-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .video-meta{padding:10px 12px}
    .video-title{font-weight:800;line-height:1.25}
    .video-author{color:var(--muted);font-size:12px;margin-top:4px}
    .video-card:hover{filter:brightness(1.04)}

    /* ==== Colores de porcentaje en toda la web ==== */
    .wr-red{   color:var(--red);   font-weight:800 }
    .wr-amber{ color:#f59e0b;      font-weight:800 }
    .wr-green{ color:var(--green); font-weight:800 }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topnav">
      <div class="brand">
        <div class="logo"><img src="./WF.png" alt="WF" onerror="this.onerror=null;this.src='./WF.png'"></div>
        <div>
          <div style="font-size:12px;color:var(--muted);line-height:1;text-transform:uppercase;letter-spacing:.16em">BSC2025Stats</div>
          <div style="font-weight:900;letter-spacing:.3px">Brawl ‚Äî Worlds 2025 </div>
        </div>
      </div>
      <div class="tabs"></div>
    </div>
  </div>

  <header class="subhead">
    <div class="eventbar">
      <div class="eventname">WORLDS ‚Äî <span>Brawl Stars</span> 2025</div>
      <nav class="pillnav" id="topNav">
        <a class="pill" data-view="stats" href="#stats">Stats</a>
        <a class="pill" data-view="teams" href="#teams">Teams</a>
        <a class="pill" data-view="scrims" href="#scrims">Casters Live</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- ============= VIEW: STATS ============= -->
    <section id="view-stats" class="view active">
      <div class="kpis">
        <div class="kpi"><div><div class="label">Total Games</div><div class="value" id="kpiGames">‚Äî</div></div></div>
        <div class="kpi"><div><div class="label">Ongoing scrims</div><div class="value" id="kpiScrims">0</div></div></div>
        <div class="kpi span-2" style="justify-content:center"><div class="value">ùïè - <a href="https://x.com/Iperibs" target="_blank" rel="noopener noreferrer">@iPeriBS</a> ¬∑ <a href="https://x.com/Ssugus__" target="_blank" rel="noopener noreferrer">@Ssugus__</a></div></div>
      </div>

      <!-- AD: imagen 'bg' que abre Discord -->
      <div class="ad">
        <a href="https://discord.gg/YeXvPmsqWT" target="_blank" rel="noopener">
          <img src="bg.png" alt="Join our Discord">
        </a>
      </div>

      <div class="grid">
        <!-- BRAWLERS -->
        <section class="card pad" id="top-brawlers">
          <div class="cardhead">
            <div class="ch-left">
              <div class="cw"><img src="./unknown.png" alt=""></div>
              <div>
                <div class="ctitle">BRAWLERS PLAYED</div>
                <div class="csub">Main Event 2025</div>
              </div>
            </div>
          </div>
          <table>
            <thead><tr><th>Brawler</th><th>Picks</th><th>Pickrate</th><th>WR</th></tr></thead>
            <tbody id="brawlerTable"></tbody>
          </table>
        </section>

        <!-- WINRATES -->
        <section class="card pad" id="winrates">
          <div class="cardhead">
            <div class="ch-left">
              <div class="cw"><img src="./unknown.png" alt=""></div>
              <div>
                <div class="ctitle">WINRATE BY GROUP</div>
                <div class="csub"><span class="group-label">Group:</span> <span id="groupTabs" class="pillnav" style="display:inline-flex;vertical-align:middle"></span></div>
              </div>
            </div>
          </div>
          <div class="chart"><canvas id="wrChart" aria-label="Winrates chart" role="img"></canvas></div>
          <table class="wr-table" style="margin-top:10px">
            <thead><tr><th>Team</th><th>Games</th><th>Win</th><th>Loss</th><th>Winrate</th></tr></thead>
            <tbody id="wrTable"></tbody>
          </table>
        </section>

        <!-- RESULTS -->
        <section class="card pad" id="ongoing">
          <div class="cardhead">
            <div class="ch-left">
              <div class="cw"><img src="./unknown.png" alt=""></div>
              <div>
                <div class="ctitle">SCRIM RESULTS</div>
                <div class="csub"><span id="countLiveOfficial">0</span> official ¬∑ <span id="countLiveScrim">0</span> scrims</div>
              </div>
            </div>
          </div>
          <div class="livegrid" id="liveList"></div>
        </section>
      </div>

      <!-- H2H -->
      <section class="card pad" id="h2h" style="margin-top:12px">
        <div class="cardhead">
          <div class="ch-left">
            <div class="cw"><img src="./unknown.png" alt=""></div>
            <div>
              <div class="ctitle">HEAD TO HEAD</div>
              <div class="csub">Winrates of each team against each other.</div>
            </div>
          </div>
        </div>
        <div class="matrix" id="h2hMatrix"></div>
      </section>
    </section>

    <!-- ============= VIEW: TEAMS ============= -->
    <section id="view-teams" class="view">
      <section class="card pad">
        <div class="cardhead">
          <div class="ch-left">
            <div class="cw"><img src="./unknown.png" alt=""></div>
            <div class="ctitle">TEAMS & ROSTERS</div>
          </div>
        </div>
        <div id="teamsWrapper" class="teams-wrapper"></div>
      </section>
    </section>

    <!-- ============= VIEW: CASTERS (2 + barra + 2) ============= -->
    <section id="view-scrims" class="view">
      <section class="card pad">
        <div class="cardhead">
          <div class="ch-left">
            <div class="cw"><img src="./unknown.png" alt=""></div>
            <div>
              <div class="ctitle">Casters Live Now</div>
              <div class="csub">Twitch arriba ¬∑ YouTube debajo</div>
            </div>
          </div>
        </div>

        <div id="castersLayout" class="casters-layout"></div>

        <div class="videos-block">
          <div class="videos-title">Caster Videos</div>
          <div id="casterVideos" class="videos-grid"></div>
        </div>
      </section>
    </section>
  </main>

<script>
  /* =================== CONFIG =================== */
  const SHEET_ID   = '1UQQx4VYkaW8ftFyjv0gs3la3F1UwG4KfMtX_ighdbqs'; // brawlers+teams
  const SHEET_FILTERS_TAB   = 'FILTERS';
  const SHEET_FILTERS_RANGE = 'V2:AC';
  const SHEET_RAWDATA_TAB   = 'RAWDATA';
  const SHEET_RAWDATA_RANGE = 'A2:AC';
  const SHEET_TEAMSWR_TAB   = 'TEAMS WR';
  const SHEET_TEAMSWR_RANGE = 'A2:E';
  const SHEET_TOTAL_GAMES_CELL = 'I8:I8';

  /* ===== H2H (tu spreadsheet) ===== */
  const FACE_SHEET_ID = '1tDOs6ZM1I6D5I8d4vX672FgXFjMpAX4hLn6-coxxhFc'; // docs id
  const FACE_SHEET_GID = '1570312858';
  const FACE_RANGE_ROW_TAGS = 'H4:H19';
  const FACE_RANGE_MATRIX   = 'J4:Y19';

  /* ===== Matches result (7 scrims) ===== */
  const MR_GID   = '793261451';
  const MR_RANGE = 'B4:D10'; // 7 filas
  const MR_SHEET_ID = FACE_SHEET_ID;

  const TEAM_LOGO_FOLDER   = './teamslogos';
  const TEAM_LOGO_EXT      = '.png';
  const BRAWLER_IMG_FOLDER = './brawlers';
  const BRAWLER_IMG_EXT    = '.png';
  const FLAG_FOLDER        = './flags';
  const FLAG_EXT           = '.png';
  const DEFAULT_IMG = './WF.png';
  const UNKNOWN_IMG = './unknown.png';

  const TOP_N_BRAWLERS = 10;

  /* =========== DATA =========== */
  const DATA = {
    brawlers: [],
    teams: [
      { id:'SK',   name:'SK GAMING',           group:'A', wins:0, losses:0, games:0, wrSheet:null },
      { id:'SSG',  name:'SPACESTATION GAMING', group:'A', wins:0, losses:0, games:0, wrSheet:null },
      { id:'RXS',  name:'REVENANT XSPARK',     group:'A', wins:0, losses:0, games:0, wrSheet:null },
      { id:'NOVO', name:'NOVO ESPORTS',        group:'A', wins:0, losses:0, games:0, wrSheet:null },
      { id:'HMB',  name:'HMBLE',               group:'B', wins:0, losses:0, games:0, wrSheet:null },
      { id:'SKC',  name:'SKCALALAS SA',        group:'B', wins:0, losses:0, games:0, wrSheet:null },
      { id:'TRB',  name:'TRIBE GAMING',        group:'B', wins:0, losses:0, games:0, wrSheet:null },
      { id:'CR',   name:'CRAZY RACCOON',       group:'B', wins:0, losses:0, games:0, wrSheet:null },
      { id:'RC',   name:'REJECT',              group:'C', wins:0, losses:0, games:0, wrSheet:null },
      { id:'LOUD', name:'LOUD',                group:'C', wins:0, losses:0, games:0, wrSheet:null },
      { id:'TH',   name:'TEAM HERETICS',       group:'C', wins:0, losses:0, games:0, wrSheet:null },
      { id:'TTM',  name:'REPLY TOTEM',         group:'C', wins:0, losses:0, games:0, wrSheet:null },
      { id:'FUT',  name:'FUT ESPORTS',         group:'D', wins:0, losses:0, games:0, wrSheet:null },
      { id:'ZETA', name:'ZETA DIVISION',       group:'D', wins:0, losses:0, games:0, wrSheet:null },
      { id:'SUP',  name:'PAPARA SUPERMASSIVE', group:'D', wins:0, losses:0, games:0, wrSheet:null },
      { id:'STMN', name:'STMN',                group:'D', wins:0, losses:0, games:0, wrSheet:null },

      /* Extras solo para logos/H2H/scrims fuera de worlds */
      { id:'NAVI', name:'NAVI',  group:'X' },
      { id:'RVL',  name:'RVL',   group:'X' },
      { id:'NXT',  name:'nxt',   group:'X' }   // archivo se llama "nxt.png"
    ],
    matches: []
  };

  /* ======= ROSTERS (players + staff) ======= */
  function iso2(country){
    if(!country) return null;
    const s = String(country).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    const map = {
      'puerto rico':'pr','mexico':'mx','mejico':'mx','guatemala':'gt','espana':'es','espanol':'es','espa√±a':'es',
      'usa':'us','estados unidos':'us','reino unido':'gb','uk':'gb',
      'canada':'ca','brasil':'br','colombia':'co','argentina':'ar','chile':'cl','peru':'pe',
      'japon':'jp','alemania':'de','francia':'fr','portugal':'pt','turkia':'tr','turquia':'tr',
      'polonia':'pl','suiza':'ch','italia':'it','india':'in','singapur':'sg','ucrania':'ua','ukrania':'ua'
    };
    return map[s]||null;
  }
  const ROSTERS = {
    TRB:[{name:'Zeus',country:'Puerto rico'},{name:'Lxffy',country:'Puerto rico'},{name:'RBM',country:'Mexico'},{name:'Killer',role:'coach',country:'Guatemala'},{name:'Sugus',role:'analyst',country:'Espa√±ol'}],
    SSG:[{name:'Chino',country:'USA'},{name:'Sans',country:'USA'},{name:'Bobby',country:'Canada'},{name:'OG',role:'coach',country:'Canada'},{name:'Quinaia',role:'analyst',country:'Brasil'}],
    STMN:[{name:'PaiN',country:'Mexico'},{name:'Juan Carlos',country:'Mexico'},{name:'Tacos',country:'Mexico'},{name:'ROLEDU',role:'coach',country:'Mexico'},{name:'Ally',role:'manager',country:'Colombia'}],
    LOUD:[{name:'Kaiodog',country:'Brasil'},{name:'Edinho',country:'Brasil'},{name:'Firecrow',country:'Brasil'},{name:'Role',role:'coach',country:'Espa√±a'},{name:'Trekking',role:'manager',country:'Argentina'}],
    SKC:[{name:'Rhz',country:'Chile'},{name:'Kristian',country:'Chile'},{name:'Prozy',country:'Peru'},{name:'DaaNTz',role:'coach',country:'Espa√±a'}],
    ZETA:[{name:'Sitetampo',country:'Japon'},{name:'Sizuku',country:'Japon'},{name:'Levi',country:'Japon'},{name:'TARO',role:'manager',country:'Japon'},{name:'Leightox',role:'analyst',country:'Polonia'}],
    RC:[{name:'Shu',country:'Japon'},{name:'Battoman',country:'Japon'},{name:'Melty',country:'Japon'}],
    SK:[{name:'Joker',country:'Alemania'},{name:'Yoshi',country:'Espa√±a'},{name:'OPE',country:'Francia'},{name:'Pedro Guijarro',role:'coach',country:'Espa√±a'},{name:'OscarDC',role:'analyst',country:'Espa√±a'},{name:'KValafar',role:'manager',country:'Portugal'}],
    HMB:[{name:'Boss',country:'Espa√±a'},{name:'Symantec',country:'Alemania'},{name:'Lukii',country:'Alemania'},{name:'Caanan',role:'coach',country:'UK'},{name:'Vid',role:'analyst',country:'Espa√±a'}],
    TH:[{name:'Zhar',country:'Mexico'},{name:'Ikaoss',country:'Espa√±a'},{name:'LeNain',country:'Suiza'},{name:'Sebas',role:'coach',country:'Colombia'}],
    FUT:[{name:'GeRo',country:'Polonia'},{name:'Nowy297',country:'Polonia'},{name:'MeOw',country:'Polonia'},{name:'Steel',role:'coach',country:'USA'},{name:'Acee',role:'analyst',country:'Brasil'},{name:'Mighty',role:'manager',country:'Turkia'}],
    NOVO:[{name:'Marco',country:'Italia'},{name:'Subeme',country:'Italia'},{name:'Biso',country:'Italia'},{name:'Dorian',role:'coach',country:'Italia'}],
    RXS:[{name:'Sergeant Clash',country:'India'},{name:'Response',country:'Singapur'},{name:'X9Jay',country:'Singapur'},{name:'Peri',role:'analyst',country:'Espa√±a'}],
    TTM:[{name:'Maury',country:'Italia'},{name:'Maru',country:'Italia'},{name:'Angelboy',country:'Ucrania'},{name:'Drage',role:'coach',country:'UK'},{name:'xCasta',role:'analyst',country:'Espa√±a'},{name:'Alez',role:'manager',country:'Espa√±a'}],
    CR:[{name:'Tensai',country:'Japon'},{name:'Moya',country:'Japon'},{name:'Milkreo',country:'Japon'},{name:'Relyh',role:'coach',country:'Japon'}],
    SUP:[{name:'Tomzy',country:'UK'},{name:'Enraged',country:'UK'},{name:'Filippo',country:'Italia'},{name:'Lukluk',role:'analyst',country:'Alemania'},{name:'iiNK',role:'manager',country:'USA'}]
  };

  /* =========== HELPERS =========== */
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function initials(n){ return (n||'').split(/\s+/).filter(Boolean).slice(0,2).map(w=>w[0].toUpperCase()).join(''); }
  function teamLogo(t){ return `${TEAM_LOGO_FOLDER}/${encodeURIComponent(t.name)}${TEAM_LOGO_EXT}`; }
  function brawlerIcon(name){ return `${BRAWLER_IMG_FOLDER}/${encodeURIComponent(name)}${BRAWLER_IMG_EXT}`; }
  function flagImgByCountry(country){ const iso=iso2(country); return iso?`${FLAG_FOLDER}/${iso}${FLAG_EXT}`:UNKNOWN_IMG; }
  function flagImgByISO(iso){ return iso?`${FLAG_FOLDER}/${iso.toLowerCase()}${FLAG_EXT}`:UNKNOWN_IMG; }

  const TEAM_ABBR = {
    'SK GAMING':'SK','HMBLE':'HMB','FUT ESPORTS':'FUT','TEAM HERETICS':'TH',
    'NOVO ESPORTS':'NOVO','REPLY TOTEM':'TTM','PAPARA SUPERMASSIVE':'SUP','TRIBE GAMING':'TRB',
    'SPACESTATION GAMING':'SSG','STMN':'STMN','ZETA DIVISION':'ZETA','REJECT':'RC',
    'REVENANT XSPARK':'RNTX','LOUD':'LOUD','CRAZY RACCOON':'CR','SKCALALAS SA':'SKC',
    /* extras */
    'NAVI':'NAVI','RVL':'RVL','nxt':'NXT'
  };

  function normName(s){ return String(s||'').toLowerCase().replace(/e[-\s]?sports|esports|gaming|team/g,'').replace(/[^a-z0-9]+/g,''); }

  async function gvizRangeGid(spreadsheetId, gid, range){
    const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&gid=${encodeURIComponent(gid)}&range=${encodeURIComponent(range)}`;
    const res = await fetch(url); const txt = await res.text();
    const start = txt.indexOf('{'); const end = txt.lastIndexOf('}');
    return JSON.parse(txt.substring(start, end+1));
  }
  async function gvizRange(sheet, range){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&range=${encodeURIComponent(range)}`;
    const res = await fetch(url); const txt = await res.text();
    const start = txt.indexOf('{'); const end = txt.lastIndexOf('}');
    return JSON.parse(txt.substring(start, end+1));
  }

  /* ==== colores porcentaje ==== */
  function classForPct(numOrText){
    let v = null;
    if (typeof numOrText === 'number') {
      v = numOrText;
    } else {
      const m = String(numOrText||'').replace(',','.').match(/[\d.]+/);
      if (m) v = parseFloat(m[0]);
    }
    if (v==null || isNaN(v)) return '';
    if (v < 35)  return 'wr-red';
    if (v <= 60) return 'wr-amber';
    return 'wr-green';
  }

  /* ===== H2H helpers ===== */
  function extractTagFromCellObj(cell){
    const txt = (cell?.f ?? cell?.v ?? '') + '';
    const first = txt.split(/\r?\n/)[0];
    const m = first.match(/^\s*([^|]+)\s*\|/); // tag antes de |
    const tag = (m ? m[1] : first).trim().toUpperCase();
    return tag || null;
  }
  function cellText(c){
    if(!c) return '';
    if(typeof c.f !== 'undefined' && c.f !== null && String(c.f).trim()!=='') return String(c.f).trim();
    if(typeof c.v !== 'undefined' && c.v !== null){
      if(typeof c.v === 'number'){
        const v = (c.v<=1 ? c.v*100 : c.v);
        return (Math.round(v*100)/100).toFixed(2).replace(/\.00$/,'') + '%';
      }
      return String(c.v).trim();
    }
    return '';
  }

  const TAG_TO_TEAM_ID = {
    RC:'RC', CR:'CR', FUT:'FUT', TH:'TH', TRB:'TRB', ZETA:'ZETA', HMB:'HMB', SKC:'SKC',
    TTM:'TTM', LOUD:'LOUD', NOVO:'NOVO', STMN:'STMN', RNTX:'RXS', RXS:'RXS', SSG:'SSG', SK:'SK', SUP:'SUP',
    NAVI:'NAVI', RVL:'RVL', NXT:'NXT'
  };
  const EXTRA_TEAMS = { NAVI:{id:'NAVI',name:'NAVI'}, RVL:{id:'RVL',name:'RVL'}, NXT:{id:'NXT',name:'nxt'} };

  function teamByTag(tag){
    const tid = TAG_TO_TEAM_ID[tag] || null;
    if(!tid) return null;
    return DATA.teams.find(t=>t.id===tid) || EXTRA_TEAMS[tag] || null;
  }
  function logoFromTag(tag){
    const t = teamByTag(tag);
    return t ? teamLogo(t) : UNKNOWN_IMG;
  }
  function abbrFromTag(tag){
    if(!tag) return '';
    const t = teamByTag(tag);
    if(!t) return tag||'';
    return TEAM_ABBR[t.name] || tag;
  }

  let H2H_ROW_TAGS=[];  // H4:H19
  let H2H_COL_TAGS=[];  // = H2H_ROW_TAGS
  let H2H_TEXT=[];      // J4:Y19

  /* ===== Helpers para letras de columna (si no los tienes ya) ===== */
function colLettersToIndex(letters){
  let n = 0;
  for (const ch of letters.toUpperCase()) n = n*26 + (ch.charCodeAt(0)-64);
  return n-1;
}
function colIndexToLetters(idx){
  let s = ''; idx = idx+1;
  while (idx > 0){ const rem = (idx-1)%26; s = String.fromCharCode(65+rem)+s; idx = Math.floor((idx-1)/26); }
  return s;
}
function columnsFromRange(rangeStr){
  const m = String(rangeStr).match(/^([A-Z]+)\d+:([A-Z]+)\d+$/i);
  if(!m) return [];
  const a = m[1].toUpperCase(), b = m[2].toUpperCase();
  const ia = colLettersToIndex(a), ib = colLettersToIndex(b);
  const out = [];
  for(let i=ia;i<=ib;i++) out.push(colIndexToLetters(i));
  return out;
}

/* ===== FIX DEFINITIVO: GViz con ancla en H (sin corrimientos jam√°s) ===== */
async function loadFaceToFaceFromSheet(){
  try{
    // 1) TAGS (H4:H19) ‚Üí orden y tama√±o N
    const tagsRes = await gvizRangeGid(FACE_SHEET_ID, FACE_SHEET_GID, FACE_RANGE_ROW_TAGS);
    const tagRows = tagsRes?.table?.rows ?? [];
    const TAGS = tagRows.map(r => extractTagFromCellObj(r?.c?.[0] ?? null));
    const N = TAGS.length;

    H2H_ROW_TAGS = [...TAGS];
    H2H_COL_TAGS = [...TAGS];

    if (!N){ H2H_TEXT=[]; return; }

    // 2) Para cada columna de datos (J..Y), pedimos "H4:<COL>19" (anclado a H)
    const COLS = columnsFromRange(FACE_RANGE_MATRIX).slice(0, N); // columnas esperadas
    const startRow = 4, endRow = 4 + N - 1;

    const colPromises = COLS.map(colLetter =>
      gvizRangeGid(FACE_SHEET_ID, FACE_SHEET_GID, `H${startRow}:${colLetter}${endRow}`)
    );
    const results = await Promise.allSettled(colPromises);

    // 3) Convertir cada respuesta en un vector de N celdas (fila por fila, sin correr)
    const columns = results.map(pr => {
      const tbl = pr.status==='fulfilled' ? (pr.value?.table || {rows:[], cols:[]}) : {rows:[], cols:[]};
      const lastIdx = Math.max(0, (tbl.cols?.length || 0) - 1); // 0=H (ancla), 1=col objetivo si existe
      // Si la columna objetivo est√° totalmente vac√≠a, GViz suele devolver solo 1 col (la H)
      const hasDataCol = (tbl.cols?.length || 0) >= 2;
      const vec = Array.from({length:N}, (_, r) => {
        const row = tbl.rows?.[r];
        if(!row) return '';
        const cell = hasDataCol ? (row.c?.[lastIdx] ?? null) : null;
        return cellText(cell); // "%", "" ‚Ä¶ sin desplazar nada
      });
      return vec;
    });

    // 4) Matriz N√óN: H2H_TEXT[r][c] = columns[c][r]
    H2H_TEXT = Array.from({length:N}, (_, r) =>
      Array.from({length:N}, (_, c) => (columns[c]?.[r] ?? ''))
    );

  }catch(err){
    console.warn('H2H (anchored) error:', err);
    H2H_ROW_TAGS = []; H2H_COL_TAGS = []; H2H_TEXT = [];
  }
}

  /* =========== BRAWLERS / TEAMS WR =========== */
  async function loadBrawlersFromSheet(){
    try{
      const [filters, raw] = await Promise.allSettled([
        gvizRange(SHEET_FILTERS_TAB, SHEET_FILTERS_RANGE),
        gvizRange(SHEET_RAWDATA_TAB, SHEET_RAWDATA_RANGE)
      ]);
      const rowsF = (filters.value?.table?.rows) || [];
      const rowsR = (raw.value?.table?.rows) || [];

      const pickrateMap = new Map();
      rowsR.forEach((r)=>{
        const n = r?.c?.[0]?.v;
        const cell = r?.c?.[28]?.v;
        if(!n || cell==null || cell==='') return;
        let pr = null;
        if(typeof cell === 'number'){ pr = cell; }
        else{ let s = String(cell).trim().replace(/\s+/g,'').replace(',','.').replace('%',''); const p=parseFloat(s); if(!isNaN(p)) pr = p; }
        if(pr!=null && !isNaN(pr)){ if(pr>1) pr = pr/100; pickrateMap.set(normName(String(n)), pr); }
      });

      const parsed=[];
      for(const r of rowsF){
        if(!r||!r.c) continue;
        const name = r.c[0]?.v; const games = r.c[1]?.v; const wrRaw = r.c[6]?.v; const pickRawFromFilters = r.c[7]?.v;
        if(!name) continue;

        let wr=null;
        if(typeof wrRaw==='number'){ wr=wrRaw; }
        else if(typeof wrRaw==='string'){ const s=wrRaw.replace(',','.'); const m=s.match(/[\d.]+/); wr = m? parseFloat(m[0])/100 : null; }

        let pickrate = null;
        if(pickRawFromFilters!=null && pickRawFromFilters!==''){
          let pr=null;
          if(typeof pickRawFromFilters==='number') pr=pickRawFromFilters;
          else{ let s = String(pickRawFromFilters).trim().replace(/\s+/g,'').replace(',','.').replace('%',''); const p=parseFloat(s); if(!isNaN(p)) pr=p; }
          if(pr!=null && !isNaN(pr)){ if(pr>1) pr = pr/100; pickrate = pr; }
        }
        if(pickrate==null){
          const qKey = normName(String(name));
          pickrate = pickrateMap.get(qKey);
          if(pickrate==null){
            const hits = [...pickrateMap.keys()].filter(k=> k.includes(qKey) || qKey.includes(k));
            if(hits.length) pickrate = pickrateMap.get(hits.sort((a,b)=>a.length-b.length)[0]);
          }
        }
        parsed.push({ id:String(name).toLowerCase().replace(/\s+/g,'-'), name, picks:Number(games)||0, pickrate, winrate:wr, image:null });
      }
      if(parsed.length) DATA.brawlers = parsed;
    }catch(e){ console.warn('Brawlers sheet error:', e); }
  }

  async function loadTeamsWRFromSheet(){
    try{
      const [wr, total] = await Promise.allSettled([
        gvizRange(SHEET_TEAMSWR_TAB, SHEET_TEAMSWR_RANGE),
        gvizRange(SHEET_TEAMSWR_TAB, SHEET_TOTAL_GAMES_CELL)
      ]);
      const map = new Map();
      for(const r of (wr.value?.table?.rows||[])){
        const name = r.c?.[0]?.v; if(!name) continue;
        const cWR = r.c?.[1]?.v; const cG = r.c?.[2]?.v; const cW = r.c?.[3]?.v; const cL = r.c?.[4]?.v;
        let wrNum=null;
        if(typeof cWR==='number') wrNum=cWR;
        else if(typeof cWR==='string'){ const s=String(cWR).replace(',','.'); const m=s.match(/[\d.]+/); wrNum = m? parseFloat(m[0]) : null; }
        map.set(normName(name), { wr:wrNum, games:Number(cG)||0, wins:Number(cW)||0, losses:Number(cL)||0 });
      }
      DATA.teams.forEach(t=>{
        const hit = map.get(normName(t.name));
        if(hit){ t.wrSheet=hit.wr; t.games=hit.games; t.wins=hit.wins; t.losses=hit.losses; }
      });
      const tg = total.value?.table?.rows?.[0]?.c?.[0]?.v;
      let games=null; if(typeof tg==='number') games=tg; else if(typeof tg==='string'){ const m=tg.match(/[\d.]+/); games = m? parseFloat(m[0]) : null; }
      if(games!=null) document.getElementById('kpiGames').textContent = games;
    }catch(e){ console.warn('Teams WR sheet error:', e); }
  }

  /* =========== KPIs =========== */
  function renderKPIs(){
    const liveScrims = DATA.matches.filter(m=>m.status==='live' && m.type==='scrim').length;
    document.getElementById('kpiScrims').textContent = liveScrims;
  }

  /* =========== BRAWLERS TABLE =========== */
  function renderTopBrawlers(){
    const tbody = document.getElementById('brawlerTable');
    const sorted = [...(DATA.brawlers||[])].sort((a,b)=>(b.picks||0)-(a.picks||0)).slice(0,TOP_N_BRAWLERS);
    tbody.innerHTML='';
    sorted.forEach(b=>{
      const pickTxt = (typeof b.pickrate==='number' && !isNaN(b.pickrate))
        ? (Math.round(b.pickrate*1000)/10)+'%'
        : (b.pickrate||'‚Äî');
      const wrPct = (typeof b.winrate==='number' && !isNaN(b.winrate))
        ? (Math.round(b.winrate*1000)/10)+'%'
        : (b.winrate||'‚Äî');
      const wrCls = classForPct(wrPct);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="champ">
            <div class="cimg"><img src="${brawlerIcon(b.name)}" alt="${b.name}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"></div>
            <span>${b.name}</span>
          </div>
        </td>
        <td>${b.picks||0}</td>
        <td>${pickTxt}</td>
        <td><span class="${wrCls}">${wrPct}</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* =========== WINRATES CHART/TABLE =========== */
  function groups(){ return [...new Set(DATA.teams.filter(t=>t.group!=='X').map(t=>t.group))].sort(); }
  let currentGroup = null;
  function renderGroupTabs(){
    const wrap = document.getElementById('groupTabs'); wrap.innerHTML='';
    groups().forEach((g,i)=>{
      const a=document.createElement('a'); a.href="#stats"; a.className='pill'+(i===0?' active':''); a.textContent=g; if(i===0) currentGroup=g;
      a.addEventListener('click',e=>{e.preventDefault(); [...wrap.querySelectorAll('.pill')].forEach(x=>x.classList.remove('active')); a.classList.add('active'); currentGroup=g; renderWinrates();});
      wrap.appendChild(a);
    });
  }
  function entriesFor(g){
    return DATA.teams.filter(t=>t.group===g).map((t)=>({
      team:t,
      abbr: TEAM_ABBR[t.name] || initials(t.name),
      value:(t.games ? (t.wins/t.games)*100 : 0)
    }));
  }
  function drawBars(canvas, entries){
    const ctx = canvas.getContext('2d'); const dpr = devicePixelRatio||1;
    const rect = canvas.getBoundingClientRect(); const W=Math.max(340,rect.width), H=360;
    canvas.width=W*dpr; canvas.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H);
    const pad={l:60,r:16,t:16,b:56}; const PW=W-pad.l-pad.r; const PH=H-pad.t-pad.b;
    ctx.fillStyle='rgba(255,255,255,.03)'; ctx.fillRect(pad.l,pad.t,PW,PH);
    ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.beginPath(); for(let y=0;y<=100;y+=20){ const yy=pad.t+PH*(1-y/100); ctx.moveTo(pad.l,yy); ctx.lineTo(pad.l+PW,yy);} ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,.6)'; ctx.font='12px Inter,system-ui'; ctx.textAlign='right'; ctx.textBaseline='middle';
    for(let y=0;y<=100;y+=20){ const yy=pad.t+PH*(1-y/100); ctx.fillText(y+'%',pad.l-8,yy); }
    const n=entries.length||1, gap=18, bw=Math.max(14,(PW-gap*(n-1))/n);
    entries.forEach((e,i)=>{
      const x=pad.l+i*(bw+gap), h=PH*(e.value/100), y=pad.t+(PH-h);
      const g=ctx.createLinearGradient(0,y,0,y+h); g.addColorStop(0,'#5b7cff'); g.addColorStop(1,'rgba(255,255,255,.2)');
      ctx.fillStyle=g; roundRect(ctx,x,y,bw,h,8); ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.stroke();
      ctx.fillStyle='#e9efff'; ctx.font='bold 12px Inter,system-ui'; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText(Math.round(e.value)+'%',x+bw/2,y-6);
      ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='12px Inter,system-ui'; ctx.textBaseline='top'; ctx.fillText(e.abbr,x+bw/2,pad.t+PH+12);
    });
  }
  function roundRect(ctx,x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }
  function renderWinrates(){
    const entries = entriesFor(currentGroup).sort((a,b)=>b.value-a.value);
    drawBars(document.getElementById('wrChart'), entries);
    const tbody = document.getElementById('wrTable'); tbody.innerHTML='';
    entries.forEach(e=>{
      const t=e.team;
      const wrVal = (t.games>0) ? (t.wins/t.games)*100 : null;
      const wrTxt = (wrVal!=null) ? wrVal.toFixed(1).replace(/\.0$/,'')+'%' : '‚Äî';
      const wrCls = classForPct(wrVal);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="champ">
            <div class="cimg"><img src="${teamLogo(t)}" alt="${t.name}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"></div>
            <span>${t.name} <span style="color:var(--muted)">(${TEAM_ABBR[t.name]||initials(t.name)})</span></span>
          </div>
        </td>
        <td>${t.games||((t.wins||0)+(t.losses||0))}</td>
        <td>${t.wins||0}</td>
        <td>${t.losses||0}</td>
        <td><b class="${wrCls}">${wrTxt}</b></td>`;
      tbody.appendChild(tr);
    });
  }

  /* =========== SCRIMS (Matches result) =========== */
  const WORLDS_TAGS = new Set(Object.keys(TAG_TO_TEAM_ID)); // incluye NAVI, RVL, NXT
  function normalizeZeyroX(s){ return String(s||'').replace(/–ó/g,'Z'); }
  function detectFUTFakeRoster(text){
    const t = normalizeZeyroX(String(text||''));
    return /DeMaster/i.test(t) && /Ferissa/i.test(t) && /Z.?yroX/i.test(t);
  }
  function extractTagsFromCellText(cellText){
    const txt = String(cellText||'');
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const tags = [];
    for(const ln of lines){
      const m = ln.match(/^\s*([^|]+)\s*\|/);
      if(m){ tags.push(m[1].trim().toUpperCase()); }
    }
    return tags;
  }
  function teamIdFromCell(cell){
    const raw = (cell?.f ?? cell?.v ?? '') + '';
    if(detectFUTFakeRoster(raw)) return null; // fuerza Unknown

    const first = raw.split(/\r?\n/)[0] || '';
    const simple = first.match(/^\s*([^|]+)\s*\|/);
    if(simple){
      const tag = simple[1].trim().toUpperCase();
      if(WORLDS_TAGS.has(tag)) return TAG_TO_TEAM_ID[tag];
    }

    const tags = extractTagsFromCellText(raw).filter(t=>WORLDS_TAGS.has(t));
    if(tags.length){
      const counts = tags.reduce((a,t)=> (a[t]=(a[t]||0)+1, a), {});
      const [topTag, cnt] = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
      if(cnt>=2) return TAG_TO_TEAM_ID[topTag];
      if(cnt===1 && Object.keys(counts).length===1) return TAG_TO_TEAM_ID[topTag];
    }
    return null; // Unknown
  }

  async function loadScrimResultsFromSheet(){
    try{
      const data = await gvizRangeGid(MR_SHEET_ID, MR_GID, MR_RANGE);
      const rows = data.table?.rows || [];
      const out = [];
      rows.forEach((r,idx)=>{
        const b = r?.c?.[0] || {}; // team1 (B)
        const c = r?.c?.[1] || {}; // team2 (C)
        const d = r?.c?.[2] || {}; // score (D)
        const t1 = teamIdFromCell(b);
        const t2 = teamIdFromCell(c);
        const score = (d?.f ?? d?.v ?? '') + '';
        out.push({
          id: idx+1,
          type:'scrim',
          status:'finished',
          stage:'Scrim',
          t1: t1 || 'UNKNOWN',
          t2: t2 || 'UNKNOWN',
          score: score
        });
      });
      DATA.matches = out.slice(0,7);
    }catch(e){ console.warn('Matches result load error:', e); }
  }

  /* =========== RESULTADOS (render) =========== */
  function logoForTeamId(id){
    const t = DATA.teams.find(tt=>tt.id===id);
    return t ? teamLogo(t) : UNKNOWN_IMG;
  }
  function abbrForTeamId(id){
    const t = DATA.teams.find(tt=>tt.id===id);
    if(!t) return 'UNK';
    return TEAM_ABBR[t.name] || initials(t.name);
  }
  function renderOngoing(){
    const live = DATA.matches.filter(m=>m.status==='live');
    document.getElementById('countLiveOfficial').textContent = live.filter(m=>m.type==='official').length;
    document.getElementById('countLiveScrim').textContent    = live.filter(m=>m.type==='scrim').length;

    const list = document.getElementById('liveList'); list.innerHTML='';
    const results = DATA.matches.slice(0,7);
    if(results.length===0){ list.innerHTML = `<div class="csub" id="liveEmptyMsg">No results right now.</div>`; return; }
    results.forEach(m=>{
      const row = document.createElement('div'); row.className='match';
      row.innerHTML = `
        <div class="side">
          <div class="tlogo"><img src="${logoForTeamId(m.t1)}" alt="${abbrForTeamId(m.t1)}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"></div>
          <div class="tname">${abbrForTeamId(m.t1)}</div>
        </div>
        <div class="tname" style="text-align:center">${m.score||''}</div>
        <div class="side right">
          <div class="tname">${abbrForTeamId(m.t2)}</div>
          <div class="tlogo"><img src="${logoForTeamId(m.t2)}" alt="${abbrForTeamId(m.t2)}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"></div>
        </div>
        <div class="csub" style="grid-column:1/-1;text-align:center;margin-top:6px">${m.stage||''}</div>`;
      list.appendChild(row);
    });
  }

  /* =========== H2H MATRIX (mismo orden, huecos incluidos) =========== */
  function renderH2HMatrix(){
    const box = document.getElementById('h2hMatrix');
    const tbl = document.createElement('table');

    // CABECERA
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    trh.innerHTML = `<th></th>` + H2H_COL_TAGS.map(tag=>{
      if(!tag) return `<th></th>`;  // celda vac√≠a si no hay tag
      const img = logoFromTag(tag);
      const ab  = abbrFromTag(tag);
      return `<th style="text-align:center">
        <div class="h2h-colhead">
          <div class="cimg"><img src="${img}" alt="${ab}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"></div>
          <div class="csub" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ab}</div>
        </div>
      </th>`;
    }).join('');
    thead.appendChild(trh);
    tbl.appendChild(thead);

    // CUERPO
    const tbody = document.createElement('tbody');
    H2H_ROW_TAGS.forEach((rowTag, rIdx)=>{
      const tr = document.createElement('tr');
      const left = rowTag ? `
        <td class="h2h-leftcell">
          <div class="champ">
            <div class="cimg"><img src="${logoFromTag(rowTag)}" alt="${abbrFromTag(rowTag)}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"></div>
            <span title="${abbrFromTag(rowTag)}">${abbrFromTag(rowTag)}</span>
          </div>
        </td>` : `<td class="h2h-leftcell"></td>`;
      let cells = '';
      for(let cIdx=0;cIdx<H2H_COL_TAGS.length;cIdx++){
        const isDiag = (rIdx===cIdx); // diagonal por √≠ndice (robusto con vac√≠os)
        const rawTxt = (H2H_TEXT[rIdx]?.[cIdx] || '').toString().trim();
        if(isDiag){
          cells += `<td class="cell-diag"></td>`;
        }else if(rawTxt){
          const cls = classForPct(rawTxt);
          cells += `<td style="text-align:center"><b class="${cls}">${rawTxt}</b></td>`;
        }else{
          cells += `<td class="cell-empty"></td>`;
        }
      }
      tr.innerHTML = left + cells;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);

    box.innerHTML=''; box.appendChild(tbl);
  }

  /* =========== TEAMS VIEW (groups + matches) =========== */
  const TEAM_REGION = {
    'SK GAMING':'EMEA','HMBLE':'EMEA','FUT ESPORTS':'EMEA','TEAM HERETICS':'EMEA',
    'NOVO ESPORTS':'EMEA','REPLY TOTEM':'EMEA','PAPARA SUPERMASSIVE':'EMEA',
    'TRIBE GAMING':'NA','SPACESTATION GAMING':'NA','STMN':'NA',
    'ZETA DIVISION':'APAC','REJECT':'APAC','CRAZY RACCOON':'APAC',
    'REVENANT XSPARK':'SEA','LOUD':'SA','SKCALALAS SA':'SA'
  };
  function regionFor(t){ return TEAM_REGION[t.name] || '‚Äî'; }

  function roleClass(role){ return role==='coach'?'coach':role==='analyst'?'analyst':role==='manager'?'manager':''; }
  function memberRow(p, isStaff=false){
    const src = flagImgByCountry(p.country);
    const role = (p.role||'player').toLowerCase();
    const chip = role!=='player' ? `<span class="role-chip ${roleClass(role)}">${role.toUpperCase()}</span>` : '';
    return `
      <div class="member ${isStaff?'staff':''}">
        <div class="flag-img"><img src="${src}" alt=""></div>
        <div class="member-name">${p.name}</div>
        <div class="member-role">${chip}</div>
      </div>`;
  }
  function teamCardHTML(t){
    const rosterRaw = (ROSTERS[t.id]||[]).map(p => (typeof p==='string')? {name:p, role:'player'}: ({role:'player', ...p}));
    const players = rosterRaw.filter(p=> (p.role||'player')==='player');
    const staff   = rosterRaw.filter(p=> (p.role||'player')!=='player');
    return `
      <article class="team-card">
        <header class="team-head">
          <div class="team-logo"><img src="${teamLogo(t)}" alt="${t.name}" onerror="this.onerror=null;this.src='${DEFAULT_IMG}'"></div>
          <div>
            <div class="team-title">${t.name}</div>
            <div class="team-meta">Region ${regionFor(t)}</div>
          </div>
          <div class="team-pill">Roster</div>
        </header>
        <div class="roster-wrap">
          ${ players.length ? `<div class="roster-section"><div class="section-title">Players</div>${players.map(p=>memberRow(p)).join('')}</div>` : '' }
          ${ staff.length ? `<div class="roster-section"><div class="section-title">Staff</div>${staff.map(p=>memberRow(p,true)).join('')}</div>` : '' }
        </div>
      </article>`;
  }
  function matchesBoardHTML(group){
    return `
      <aside class="matches-board" style="grid-column:3;grid-row:1 / span 2">
        <div class="mb-title">Matches <span class="mb-muted">(Group ${group})</span></div>

        <div class="mb-round">Opening Matches</div>
        <div class="mb-row"><div class="mb-team"><span class="mb-badge">TBD</span></div><div class="mb-center">i</div><div class="mb-team"><span class="mb-badge">TBD</span></div></div>
        <div class="mb-row"><div class="mb-team"><span class="mb-badge">TBD</span></div><div class="mb-center">i</div><div class="mb-team"><span class="mb-badge">TBD</span></div></div>

        <div class="mb-round">Winner's Match</div>
        <div class="mb-row"><div class="mb-team"><span class="mb-badge">TBD</span></div><div class="mb-center">i</div><div class="mb-team"><span class="mb-badge">TBD</span></div></div>

        <div class="mb-round">Elimination Match</div>
        <div class="mb-row"><div class="mb-team"><span class="mb-badge">TBD</span></div><div class="mb-center">i</div><div class="mb-team"><span class="mb-badge">TBD</span></div></div>

        <div class="mb-round">Decider Match</div>
        <div class="mb-row"><div class="mb-team"><span class="mb-badge">TBD</span></div><div class="mb-center">i</div><div class="mb-team"><span class="mb-badge">TBD</span></div></div>
      </aside>`;
  }
  function renderTeamsView(){
    const wrap = document.getElementById('teamsWrapper'); wrap.innerHTML='';
    groups().forEach(g=>{
      const block = document.createElement('section'); block.className='group-block';
      block.innerHTML = `<div class="group-title">Group ${g}</div><div class="group-grid" id="grid-${g}"></div>`;
      wrap.appendChild(block);
      const grid = block.querySelector('.group-grid');
      const ts = DATA.teams.filter(t=>t.group===g);
      const slots = [
        {col:1,row:1, team:ts[0]}, {col:2,row:1, team:ts[1]},
        {col:1,row:2, team:ts[2]}, {col:2,row:2, team:ts[3]},
      ];
      slots.forEach(s=>{
        if(!s.team) return;
        const el = document.createElement('div');
        el.innerHTML = teamCardHTML(s.team);
        const card = el.firstElementChild;
        card.style.gridColumn = s.col; card.style.gridRow = s.row; grid.appendChild(card);
      });
      const m = document.createElement('div'); m.innerHTML = matchesBoardHTML(g); grid.appendChild(m.firstElementChild);
    });
  }

  /* =========== CASTERS VIEW (2 + barra + 2) =========== */
  function casterCardHTML(c){
    const flag = c.country ? `<span class="creator-flag"><img src="${flagImgByISO(c.country)}" alt=""></span>` : '';
    return `
      <article class="creator-card" data-caster="${c.name}">
        <div class="creator-top">
          <div class="creator-avatar"><img src="${c.logo}" alt="${c.name}" onerror="this.onerror=null;this.src='${UNKNOWN_IMG}'"></div>
          <div>
            <div class="creator-name">${c.name}</div>
            <div class="creator-real">${c.real||''} ${flag}</div>
          </div>
        </div>
        <div class="creator-footer">
          ${c.links?.x ? `<a class="btn-icon btn-x" href="${c.links.x}" target="_blank" rel="noopener noreferrer" title="X"><img src="./social/x.png" alt="X"></a>`:''}
          ${c.links?.yt ? `<a class="btn-icon btn-yt" href="${c.links.yt}" target="_blank" rel="noopener noreferrer" title="YouTube"><img src="./social/yt.png" alt="YouTube"></a>`:''}
          ${c.links?.twitch ? `<a class="btn-icon btn-tw" href="${c.links.twitch}" target="_blank" rel="noopener noreferrer" title="Twitch"><img src="./social/twitch.png" alt="Twitch"></a>`:''}
          <span class="live-chip" style="display:none">LIVE</span>
        </div>
      </article>`;
  }
  const CASTER_DATA = [
    { name:'NacoTV',   real:'Ignacio Alvarez', country:'AR', logo:'./social/naco.jpeg',
      links:{ x:'https://x.com/NacoTV_', yt:'https://www.youtube.com/@nacotv2', twitch:'https://www.twitch.tv/naconeta' } },
    { name:'Spiuk',    real:'Manuel Fern√°ndez Asua', country:'ES', logo:'./social/spiuk.jpg',
      links:{ x:'https://x.com/SpiukYT', yt:'https://www.youtube.com/@BrawlHispano', twitch:'https://www.twitch.tv/spiukbs' },
      ytExtra:['https://www.youtube.com/@BrawlHispano'] },
    { name:'DelMoYOu', real:'Javier del Moral Alarc√≥n', country:'ES', logo:'./social/delmoyou.jpeg',
      links:{ x:'https://x.com/DelMoYOu', yt:'https://www.youtube.com/@DelMoYOu', twitch:'https://www.twitch.tv/delmoyou' } },
    { name:'NeaRz',    real:'Luis Guevara', country:'mx', logo:'./social/nearz.jpg',
      links:{ x:'https://x.com/n_earz', yt:'https://www.youtube.com/channel/UCdC302gH9H6kdnUBFCqY5Fg', twitch:'https://www.twitch.tv/nearz_z' } }
  ];
  function renderScrimsView(){
    const wrap = document.getElementById('castersLayout'); wrap.innerHTML='';
    const [c1,c2,c3,c4] = CASTER_DATA;
    if(c1){ const el=document.createElement('div'); el.innerHTML=casterCardHTML(c1); wrap.appendChild(el.firstElementChild); }
    if(c2){ const el=document.createElement('div'); el.innerHTML=casterCardHTML(c2); wrap.appendChild(el.firstElementChild); }

    const bar = document.createElement('aside'); bar.className='scrims-bar';
    bar.innerHTML = `<div class="title">Casters Live Now</div><div id="liveCastersList"></div>`;
    wrap.appendChild(bar);

    if(c3){ const el=document.createElement('div'); el.innerHTML=casterCardHTML(c3); wrap.appendChild(el.firstElementChild); }
    if(c4){ const el=document.createElement('div'); el.innerHTML=casterCardHTML(c4); wrap.appendChild(el.firstElementChild); }

    renderCasterVideos();
    checkAllCastersLive().catch(()=>{});
  }

  /* ======= Videos ======= */
  function ytId(u){
    try{
      const url = new URL(u);
      if(url.hostname === 'youtu.be') return url.pathname.slice(1);
      const v = url.searchParams.get('v'); if(v) return v;
      const m = url.pathname.match(/\/embed\/([^\/\?]+)/); return m? m[1] : null;
    }catch(_){ return null; }
  }
  async function fetchYTMeta(url){
    try{
      const res = await fetch(`https://www.youtube.com/oembed?format=json&url=${encodeURIComponent(url)}`);
      if(!res.ok) throw new Error('oEmbed failed');
      const j = await res.json();
      return { title:j.title, author:j.author_name };
    }catch(e){
      return null;
    }
  }
  function videoCardHTML({id,thumb,title='Loading‚Ä¶',author=''}){
    return `
      <a class="video-card" href="https://www.youtube.com/watch?v=${id}" target="_blank" rel="noopener noreferrer">
        <div class="video-thumb"><img loading="lazy" src="${thumb}" alt="${title}"></div>
        <div class="video-meta">
          <div class="video-title">${title}</div>
          <div class="video-author">${author}</div>
        </div>
      </a>`;
  }
  async function renderCasterVideos(){
    const grid = document.getElementById('casterVideos'); if(!grid) return;
    grid.innerHTML = '';
    const urls = [
      'https://www.youtube.com/watch?v=B9ytE7x6-T4',
      'https://www.youtube.com/watch?v=dFrHJpblzS0',
      'https://www.youtube.com/watch?v=-lMBsCJsctQ',
      'https://www.youtube.com/watch?v=AS0ryeLyisQ',
      'https://www.youtube.com/watch?v=ofC859O60EI',
      'https://www.youtube.com/watch?v=g6pSLApMdU4',
      'https://www.youtube.com/watch?v=LEx7zz4vrxA',
      'https://www.youtube.com/watch?v=QDgnTXgh3r8'
    ];
    const items = urls.map(u=>({ id:ytId(u), url:u, caster:'', thumb: ytId(u) ? `https://i.ytimg.com/vi/${ytId(u)}/hqdefault.jpg` : './unknown.png' }))
                      .filter(x=>x.id);

    items.forEach(it=>{
      const el = document.createElement('div');
      el.innerHTML = videoCardHTML({id:it.id, thumb:it.thumb, title:'Loading‚Ä¶', author:''});
      grid.appendChild(el.firstElementChild);
    });

    await Promise.allSettled(items.map(async (it, idx)=>{
      const meta = await fetchYTMeta(it.url);
      const card = grid.children[idx];
      if(card){
        const img = card.querySelector('.video-thumb img');
        const titleEl = card.querySelector('.video-title');
        const authorEl = card.querySelector('.video-author');
        if(img) img.alt = meta?.title || `YouTube video`;
        if(titleEl) titleEl.textContent = meta?.title || `YouTube video`;
        if(authorEl) authorEl.textContent = meta?.author || '';
      }
    }));
  }

  /* ======= Live detection (YouTube + Twitch) ======= */
  function twitchUserFromUrl(u){
    try{ const p=new URL(u); if(p.hostname.includes('twitch.tv')){ const seg=p.pathname.replace(/^\/+/,'').split('/'); return seg[0]||null; } }catch(_){}
    return null;
  }
  async function isYouTubeLiveForChannel(channelUrl){
    const liveUrl = channelUrl.replace(/\/+$/,'') + '/live';
    try{
      const r = await fetch(`https://www.youtube.com/oembed?format=json&url=${encodeURIComponent(liveUrl)}`);
      if(!r.ok) return { live:false };
      const j = await r.json();
      return { live:true, title:j.title, author:j.author_name, url:liveUrl, thumb:j.thumbnail_url };
    }catch(_){ return { live:false }; }
  }
  async function twitchLiveInfo(user){
    if(!user) return {live:false};
    try{
      const uptime = await fetch(`https://decapi.me/twitch/uptime/${encodeURIComponent(user)}`).then(r=>r.text());
      if(/offline/i.test(uptime)) return {live:false};
      const title = await fetch(`https://decapi.me/twitch/status/${encodeURIComponent(user)}`).then(r=>r.text()).catch(()=>null);
      return {live:true, title:title||'Live on Twitch', url:`https://www.twitch.tv/${user}`};
    }catch(_){ return {live:false}; }
  }

  const LIVE_STATE = {}; // { casterName: { yt:[{...}], tw:{...}, logo, author } }

  async function checkAllCastersLive(){
    const results = {};
    for(const c of CASTER_DATA){
      const ytList = [];
      const base = c.links?.yt ? [c.links.yt] : [];
      const extra = c.ytExtra ? [...c.ytExtra] : [];

      // Asegurar el canal BrawlHispano para Spiuk
      if(c.name==='Spiuk' && ![...base,...extra].some(u=>/@BrawlHispano/i.test(u||''))){
        extra.push('https://www.youtube.com/@BrawlHispano');
      }

      for(const ytu of [...base, ...extra]){
        if(!ytu) continue;
        const info = await isYouTubeLiveForChannel(ytu);
        if(info.live) ytList.push(info);
      }
      const twitchUser = twitchUserFromUrl(c.links?.twitch);
      const twInfo = await twitchLiveInfo(twitchUser);

      results[c.name] = { yt: ytList, tw: twInfo.live? twInfo : null, logo: c.logo, author:c.name };
    }
    Object.assign(LIVE_STATE, results);
    renderLiveCastersSection();
    updateCasterCardsLiveBadges();
    setTimeout(()=>checkAllCastersLive().catch(()=>{}), 60000);
  }

  function renderLiveCastersSection(){
    const box = $('#liveCastersList'); if(!box) return;
    const items = [];
    Object.entries(LIVE_STATE).forEach(([caster, st])=>{
      const hasYT = st.yt && st.yt.length;
      const hasTW = !!st.tw;
      if(!hasYT && !hasTW) return;
      const yt = hasYT ? st.yt[0] : null;
      const logo = st.logo || UNKNOWN_IMG;
      const titleTop = hasTW ? (st.tw.title || 'Live on Twitch') : (yt?.title || 'Live now');
      const author = yt?.author || caster;
      const platforms = `
        <div class="platforms">
          ${hasTW ? `<a href="${st.tw.url}" target="_blank" rel="noopener" title="Watch on Twitch"><img src="./social/twitch.png" alt="Twitch"><span>Twitch</span></a>`:''}
          ${hasYT ? `<a href="${yt.url}" target="_blank" rel="noopener" title="Watch on YouTube"><img src="./social/yt.png" alt="YouTube"><span>YouTube</span></a>`:''}
        </div>`;
      items.push(`
        <div class="live-item">
          <div class="avatar"><img src="${logo}" alt="${author}"></div>
          <div>
            <div class="title">${titleTop}</div>
            <div class="author">${author}</div>
          </div>
          ${platforms}
        </div>`);
    });
    box.innerHTML = items.length ? items.join('') : `<div class="csub">No casters live now.</div>`;
  }

  
  function updateCasterCardsLiveBadges(){
    CASTER_DATA.forEach(c=>{
      const card = document.querySelector(`.creator-card[data-caster="${c.name}"]`);
      if(!card) return;
      const badge = card.querySelector('.live-chip');
      const btnYT = card.querySelector('.btn-yt');
      const btnTW = card.querySelector('.btn-tw');
      const st = LIVE_STATE[c.name] || {};
      const hasYT = st.yt && st.yt.length;
      const hasTW = !!st.tw;

      if(hasYT && btnYT){ btnYT.href = st.yt[0].url; }
      if(hasTW && btnTW){ btnTW.href = st.tw.url; }
      if(badge){ badge.style.display = (hasYT || hasTW) ? 'inline-block' : 'none'; }
    });
  }

  /* =========== ROUTER (hash) =========== */
  function setViewFromHash(){
    const hash = (location.hash || '#stats').replace('#','');
    const viewId = hash==='teams' ? 'view-teams' : hash==='scrims' ? 'view-scrims' : 'view-stats';
    $$('.view').forEach(v=>v.classList.toggle('active', v.id===viewId));
    $$('#topNav .pill').forEach(a=> a.classList.toggle('active', a.dataset.view===hash || (hash==='' && a.dataset.view==='stats')));
    if(viewId==='view-teams') renderTeamsView();
    if(viewId==='view-scrims') renderScrimsView();
    window.scrollTo({top:0,behavior:'smooth'});
  }
  window.addEventListener('hashchange', setViewFromHash);

  /* =========== INIT =========== */
  async function init(){
    await Promise.allSettled([
      loadBrawlersFromSheet(),
      loadTeamsWRFromSheet(),
      loadFaceToFaceFromSheet(),
      loadScrimResultsFromSheet()
    ]);
    renderKPIs();
    renderTopBrawlers();
    renderGroupTabs();
    renderWinrates();
    try{ new ResizeObserver(()=>renderWinrates()).observe(document.getElementById('wrChart')); }catch(_){}
    renderOngoing();
    renderH2HMatrix();
    setViewFromHash();
  }
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
